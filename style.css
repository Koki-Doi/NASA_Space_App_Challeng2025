/* ================= Base / Layout ================= */
*,
*::before,
*::after { box-sizing: border-box; }
html, body { height: 100vh; margin: 0; }
html, body { overflow: hidden; } /* global scrollbar off */

:root{
  --topbar-h: 56px;

  --bg: #000; --bg-2: #0f0f0f; --fg: #eaeaea; --card: #1e1e1e; --border: #222;

  --s-1: 4px; --s-2: 8px; --s-3: 12px; --s-4: 16px;

  /* KPI sizes */
  --kpi-pad-y: 6px; --kpi-pad-x: 10px; --kpi-gap: 6px;
  --kpi-title-size: 16px; --kpi-value-size: 36px; --kpi-unit-size: 16px;

  /* colormap width (1.5x) */
  --cm-width: 108px;

  /* columns width */
  --sidebar-w: 260px;
  --panel-w: 280px;
}

body{
  background: var(--bg);
  color: var(--fg);
  font-family: system-ui, "Segoe UI", Roboto, Arial, sans-serif;
}

/* ================= Loading Screen ================= */
.loading-screen{
  position: fixed; inset: 0; z-index: 1000;
  display: grid; place-items: center;
  background: radial-gradient(1200px 800px at 50% 40%, #0b0b0b, #000000);
}
.loading-card{
  width: min(520px, 92vw);
  background: #121212;
  border: 1px solid #2a2a2a;
  border-radius: 16px;
  padding: 18px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.45);
}
.loading-title{
  font-size: 18px; font-weight: 700; margin-bottom: 4px;
}
.loading-sub{
  font-size: 12px; color: #9aa; margin-bottom: 12px;
}
.spinner{
  width: 40px; height: 40px; border-radius: 50%;
  border: 3px solid #2b2b2b; border-top-color: #eaeaea;
  animation: spin 0.9s linear infinite;
  margin: 6px auto 10px;
}
@keyframes spin { to { transform: rotate(360deg); } }
.progress-wrap{
  width: 100%; height: 10px; background: #0d0d0d;
  border: 1px solid #2b2b2b; border-radius: 999px; overflow: hidden;
}
.progress-bar{
  height: 100%; width: 0%;
  background: linear-gradient(90deg, #55aaff, #74ffd4 60%, #ffffff);
  box-shadow: 0 0 12px rgba(116,255,212,0.35);
  transition: width 120ms ease;
}
.loading-text{
  text-align: center; font-size: 12px; color: #cfcfcf; margin-top: 8px;
}
.loading-detail{
  text-align: center; font-size: 11px; color: #9aa; margin-top: 4px;
}

/* ---------------- Topbar ---------------- */
.topbar{
  height: var(--topbar-h);
  display:flex; align-items:center; justify-content:space-between;
  padding:0 var(--s-3);
  background:#121212; border-bottom:1px solid var(--border);
  white-space:nowrap;
}
.brand{ display:flex; align-items:center; gap:var(--s-2); min-width:0; }
.logo{ font-size:20px; }
.title{
  font-size:16px; margin:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
}
.controls{ display:flex; align-items:center; gap:var(--s-2); }
.control{
  padding:6px 8px; background:#101010; color:var(--fg);
  border:1px solid #333; border-radius:6px;
}
.ml{ margin-left:var(--s-3); }

.ghost{
  background:transparent; border:1px solid #333; color:#ddd;
  padding:6px 10px; border-radius:6px; cursor:pointer;
}
.sm{ font-size:12px; }
.only-narrow{ display:none; }

/* ---------------- Main ---------------- */
.container{
  position:absolute; top:var(--topbar-h); left:0; right:0; bottom:0;
  display:flex;
}

/* Sidebar */
.sidebar{
  width:var(--sidebar-w); background:var(--bg-2);
  padding:14px; border-right:1px solid var(--border);
  overflow:hidden;
  z-index:20;
}
.group{ display:flex; flex-direction:column; margin-bottom:var(--s-3); }
.group label{ font-size:12px; color:#aaa; margin-bottom:var(--s-1); }
.group select{
  padding:8px; background:#101010; color:var(--fg);
  border:1px solid #333; border-radius:6px;
}
.check{ display:flex; align-items:center; gap:8px; font-size:13px; margin:8px 0; }

/* Viewer */
.viewer{ position:relative; flex:1; overflow:hidden; }

/* Panel */
.panel{
  width:var(--panel-w); background:var(--bg-2);
  padding:var(--s-2); border-left:1px solid var(--border);
  display:grid; grid-template-columns:1fr; gap:var(--s-2);
  overflow:hidden; z-index:20;
}

/* Overlay */
.overlay{
  position:fixed; inset:0; background:rgba(0,0,0,0.4);
  opacity:0; pointer-events:none; transition:opacity 150ms ease; z-index:15;
}
.overlay.show{ opacity:1; pointer-events:auto; }

/* ---------------- KPI ---------------- */
.kpi{
  background:var(--card); border:1px solid #2a2a2a; border-radius:12px;
  padding:var(--kpi-pad-y) var(--kpi-pad-x);
  display:grid; grid-template-columns:auto 1fr auto; gap:var(--kpi-gap);
  align-items:end;
  min-height:0;
}
.kpi-title{ font-size:var(--kpi-title-size); color:#9aa; }
.kpi-value{
  font-size:var(--kpi-value-size); font-weight:700; line-height:1.1;
  text-align:center; justify-self:center; align-self:center;
}
.kpi-unit{ font-size:var(--kpi-unit-size); color:#9aa; }

/* ---------------- Canvas / Colormap ---------------- */
canvas{ display:block; width:100%; height:100%; }
.colormap{
  position:absolute; top:var(--s-2); right:var(--s-2);
  width:var(--cm-width); height:auto; opacity:0.95; border-radius:6px;
  pointer-events:none; image-rendering:crisp-edges;
}

/* ---------------- Cards ---------------- */
.env-card, .props-card, .figure-card{
  background:#131313; border:1px solid #2a2a2a; border-radius:10px; padding:10px;
}
.env-header, .props-header, .figure-header{ display:flex; flex-direction:column; gap:2px; margin-bottom:6px; }
#envTitle, #propsTitle, #figureTitle{ font-size:12px; color:#9aa; }
.props-name{ font-size:12px; color:#cfcfcf; opacity:0.9; }

.env-grid, .props-grid{
  display:grid; grid-template-columns: 1fr auto; gap:4px 8px; font-size:12px;
}
.e-key, .p-key{ color:#9aa; } .e-val, .p-val{ color:#ddd; text-align:right; }

/* Figure image */
.env-figure{
  width:100%; height:auto; display:block;
  border-radius:8px; border:1px solid #222;
  max-height:28vh; object-fit:contain;
}
.figure-caption{
  font-size:11px; color:#9aa; margin-top:6px; line-height:1.3;
}

/* ================= Responsive ================= */
@media (max-width: 1280px){
  :root{
    --sidebar-w: 240px;
    --panel-w: 260px;
    --kpi-title-size: 15px; --kpi-value-size: 32px; --kpi-unit-size: 15px;
  }
  .env-figure{ max-height:24vh; }
}

@media (max-width: 1024px){
  .only-narrow{ display:inline-flex; }
  .sidebar, .panel{
    position:fixed; top:var(--topbar-h); bottom:0;
    height:calc(100vh - var(--topbar-h));
    box-shadow:0 0 20px rgba(0,0,0,0.5);
  }
  .sidebar{ left:0; transform:translateX(-100%); transition:transform 150ms ease; }
  .sidebar.open{ transform:translateX(0); }
  .panel{ right:0; transform:translateX(100%); transition:transform 150ms ease; }
  .panel.open{ transform:translateX(0); }
  .container{ left:0; right:0; }
}

@media (max-width: 640px){
  :root{
    --sidebar-w: 85vw;
    --panel-w: 85vw;
    --kpi-title-size: 14px; --kpi-value-size: 28px; --kpi-unit-size: 14px;
    --cm-width: 84px; /* shrink colormap */
  }
  .env-figure{ max-height:20vh; }
  .figure-caption{ font-size:10px; }
}

/* ====== Smartphone only: KPIパネル＆スライダーの下側余白を増やす ====== */
@media (max-width: 640px){
  /* iPhoneのホームインジケータ/検索バーを考慮して安全に下余白を確保 */
  :root{
    /* 必要なら数値だけ調整してください（既定: 24px） */
    --extra-bottom-pad: 64px;
  }

  /* KPIパネル全体の下側に余白（安全領域込み） */
  .panel{
    padding-bottom: calc(var(--extra-bottom-pad) + env(safe-area-inset-bottom, 0px));
  }

  /* サイドバー（スライダーを含む領域）の下側にも余白（安全領域込み） */
  .sidebar{
    padding-bottom: calc(var(--extra-bottom-pad) + env(safe-area-inset-bottom, 0px));
  }

  /* スライダーが最後に来るケースで、最下段のコントロール群だけ更に余裕を足す
     （HTMLのクラス追加なしで効く最小限の指定） */
  .sidebar .group:last-child{
    margin-bottom: calc(var(--extra-bottom-pad) + env(safe-area-inset-bottom, 0px));
  }

  /* rangeスライダーのタップしやすさ＆誤タップ回避のための“当たり”を少しだけ増やす
     見た目を変えない（高さは親のpadding/marginだけで確保） */
  .sidebar input[type="range"]{
    touch-action: pan-y;
  }
}

